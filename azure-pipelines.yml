# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  - master

pool:
  vmImage: ubuntu-latest

jobs:
  - job: Build
    displayName: 'Build and Test'
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '14.x'
        displayName: 'Install Node.js'

      - script: |
          npm install
          npm run build
        displayName: 'npm install and build'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: drop'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'
          publishLocation: 'Container'

  - job: Deploy
    displayName: 'Deploy to Azure Storage'
    dependsOn: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: UseDotNet@2
        inputs:
          packageType: 'sdk'
          version: '3.x'
          installationPath: $(Agent.ToolsDirectory)/dotnet

      - script: |
          echo "Source directory: $(Build.ArtifactStagingDirectory)"
          export AZURE_CLIENT_ID=$(AZURE_CLIENT_ID)
          export AZURE_CLIENT_SECRET=$(AZURE_CLIENT_SECRET)
          export AZURE_TENANT_ID=$(AZURE_TENANT_ID)
          az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
        displayName: 'Set up Azure credentials'

      - script: |
          az storage blob upload-batch --account-name yabasirastorageaccount --auth-mode login --destination '$web' --source '$(Build.ArtifactStagingDirectory)'
        displayName: 'Upload files to Azure Storage'
        env:
          AZURE_STORAGE_ACCOUNT: yabasirastorageaccount

